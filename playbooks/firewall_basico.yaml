---
- name: Firewall basico (multiplas distros)
  hosts: all
  become: true
  vars:
    firewall_allow_ssh_port: 22
    firewall_freebsd_enable_pf: false
  tasks:
    - name: Instalar UFW (Debian/Ubuntu)
      when: ansible_os_family == "Debian"
      ansible.builtin.apt:
        name: ufw
        state: present
        update_cache: true

    - name: Permitir SSH no UFW
      when: ansible_os_family == "Debian"
      community.general.ufw:
        rule: allow
        port: "{{ firewall_allow_ssh_port }}"
        proto: tcp

    - name: Ativar UFW
      when: ansible_os_family == "Debian"
      community.general.ufw:
        state: enabled

    - name: Instalar firewalld (RedHat/CentOS)
      when: ansible_os_family == "RedHat"
      ansible.builtin.yum:
        name: firewalld
        state: present

    - name: Garantir firewalld ativo
      when: ansible_os_family == "RedHat"
      ansible.builtin.service:
        name: firewalld
        state: started
        enabled: true

    - name: Permitir SSH no firewalld
      when: ansible_os_family == "RedHat"
      ansible.posix.firewalld:
        service: ssh
        permanent: true
        state: enabled
        immediate: true

    - name: Configurar pf (FreeBSD)
      when:
        - ansible_system == "FreeBSD"
        - firewall_freebsd_enable_pf
      ansible.builtin.copy:
        dest: /etc/pf.conf
        mode: "0644"
        content: |
          set skip on lo0
          block in all
          pass in on egress proto tcp to port {{ firewall_allow_ssh_port }} keep state

    - name: Habilitar pf no boot (FreeBSD)
      when:
        - ansible_system == "FreeBSD"
        - firewall_freebsd_enable_pf
      ansible.builtin.command: sysrc pf_enable=YES
      changed_when: true

    - name: Iniciar pf (FreeBSD)
      when:
        - ansible_system == "FreeBSD"
        - firewall_freebsd_enable_pf
      ansible.builtin.service:
        name: pf
        state: started
        enabled: true
