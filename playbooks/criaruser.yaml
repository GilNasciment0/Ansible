---
- name: Criar usuario
  hosts: all
  become: true
  vars:
    username: user-ish-siem
    user_password: ""
    comment: "usuario do SIEM"
    user_groups_debian: sudo
    user_groups_redhat: wheel
  tasks:
    - name: Validar senha do usuario
      ansible.builtin.assert:
        that:
          - user_password | length > 0
        fail_msg: "Defina a variavel user_password (idealmente via Vault ou Semaphore)."

    - name: Definir grupo por familia
      ansible.builtin.set_fact:
        user_groups: "{{ user_groups_debian if ansible_os_family == 'Debian' else user_groups_redhat }}"

    - name: Criar usuario
      ansible.builtin.user:
        name: "{{ username }}"
        comment: "{{ comment }}"
        password: "{{ user_password | password_hash('sha512') }}"
        groups: "{{ user_groups }}"
        shell: /bin/bash
      no_log: true
